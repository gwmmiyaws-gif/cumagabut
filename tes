--!strict
-- Plenger Hub Premium - Blatant Fishing & Auto Totem + Auto Favorite
-- Delta Executor Compatible

local WindUI

do
    local ok, result = pcall(function()
        return require("./src/Init")
    end)
    
    if ok then
        WindUI = result
    else 
        WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
    end
end

-- =====================================================
-- TYPE DEFINITIONS
-- =====================================================
type RemoteEvent = RemoteEvent
type RemoteFunction = RemoteFunction
type Vector3 = Vector3
type CFrame = CFrame

-- =====================================================
-- SERVICES & GLOBALS
-- =====================================================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local LocalPlayer: Player = Players.LocalPlayer
local RPath: {string} = {"Packages", "_Index", "sleitnick_net@0.2.0", "net"}

-- =====================================================
-- HELPER FUNCTIONS
-- =====================================================
local function GetRemote(remotePath: {string}, name: string, timeout: number?): Instance?
    local currentInstance: Instance = ReplicatedStorage
    for _, childName in ipairs(remotePath) do
        local child = currentInstance:WaitForChild(childName, timeout or 0.5)
        if not child then 
            return nil 
        end
        currentInstance = child
    end
    return currentInstance:FindFirstChild(name)
end

local function GetHRP(): BasePart?
    local Character = LocalPlayer.Character
    if not Character then
        Character = LocalPlayer.CharacterAdded:Wait()
    end
    return Character:WaitForChild("HumanoidRootPart", 5) :: BasePart
end

-- =====================================================
-- REMOTE DEFINITIONS
-- =====================================================
local RE_EquipToolFromHotbar = GetRemote(RPath, "RE/EquipToolFromHotbar") :: RemoteEvent?
local RF_ChargeFishingRod = GetRemote(RPath, "RF/ChargeFishingRod") :: RemoteFunction?
local RF_RequestFishingMinigameStarted = GetRemote(RPath, "RF/RequestFishingMinigameStarted") :: RemoteFunction?
local RE_FishingCompleted = GetRemote(RPath, "RE/FishingCompleted") :: RemoteEvent?
local RF_CancelFishingInputs = GetRemote(RPath, "RF/CancelFishingInputs") :: RemoteFunction?
local RF_UpdateAutoFishingState = GetRemote(RPath, "RF/UpdateAutoFishingState") :: RemoteFunction?
local RE_SpawnTotem = GetRemote(RPath, "RE/SpawnTotem") :: RemoteEvent?
local RE_EquipItem = GetRemote(RPath, "RE/EquipItem") :: RemoteEvent?
local RE_UnequipItem = GetRemote(RPath, "RE/UnequipItem") :: RemoteEvent?
local RE_FavoriteItem = GetRemote(RPath, "RE/FavoriteItem") :: RemoteEvent?

-- =====================================================
-- UTILITY MODULES (DELTA COMPATIBLE LOADING)
-- =====================================================
local ItemUtility = nil
local TierUtility = nil
local UtilitiesLoaded = false

-- Multiple loading attempts for Delta compatibility
local function LoadUtilitiesWithRetry()
    local attempts = {
        -- Attempt 1: Original path
        function()
            local SharedFolder = ReplicatedStorage:WaitForChild("Shared", 5)
            if SharedFolder then
                ItemUtility = require(SharedFolder:WaitForChild("ItemUtility", 3))
                TierUtility = require(SharedFolder:WaitForChild("TierUtility", 3))
                return true
            end
            return false
        end,
        -- Attempt 2: Utilities path
        function()
            local UtilitiesFolder = ReplicatedStorage:WaitForChild("Utilities", 5)
            if UtilitiesFolder then
                ItemUtility = require(UtilitiesFolder:WaitForChild("ItemUtility", 3))
                TierUtility = require(UtilitiesFolder:WaitForChild("TierUtility", 3))
                return true
            end
            return false
        end,
        -- Attempt 3: Libraries path
        function()
            local LibrariesFolder = ReplicatedStorage:WaitForChild("Libraries", 5)
            if LibrariesFolder then
                ItemUtility = require(LibrariesFolder:WaitForChild("ItemUtility", 3))
                TierUtility = require(LibrariesFolder:WaitForChild("TierUtility", 3))
                return true
            end
            return false
        end,
        -- Attempt 4: Search descendants
        function()
            local itemUtilModule = nil
            local tierUtilModule = nil
            
            for _, descendant in ipairs(ReplicatedStorage:GetDescendants()) do
                if descendant.Name == "ItemUtility" and descendant:IsA("ModuleScript") then
                    itemUtilModule = descendant
                end
                if descendant.Name == "TierUtility" and descendant:IsA("ModuleScript") then
                    tierUtilModule = descendant
                end
                if itemUtilModule and tierUtilModule then
                    break
                end
            end
            
            if itemUtilModule and tierUtilModule then
                ItemUtility = require(itemUtilModule)
                TierUtility = require(tierUtilModule)
                return true
            end
            return false
        end
    }
    
    for i, attemptFunc in ipairs(attempts) do
        local success = pcall(function()
            if attemptFunc() then
                UtilitiesLoaded = true
                print("[Plenger Hub] ‚úÖ Utilities loaded successfully (Attempt " .. i .. ")")
                return true
            end
        end)
        
        if success and UtilitiesLoaded then
            return true
        end
        
        task.wait(0.5)
    end
    
    warn("[Plenger Hub] ‚ùå All utility loading attempts failed")
    return false
end

-- Try loading utilities
task.spawn(function()
    task.wait(2)
    LoadUtilitiesWithRetry()
end)

-- =====================================================
-- BLATANT FISHING VARIABLES
-- =====================================================
local blatantInstantState: boolean = false
local blatantLoopThread: thread? = nil
local blatantEquipThread: thread? = nil

local completeDelay: number = 3.055
local cancelDelay: number = 0.3
local loopInterval: number = 1.715

_G.PlengerHub_BlatantActive = false

-- =====================================================
-- TOTEM VARIABLES (ENHANCED WITH PERSISTENT TIMER)
-- =====================================================
local AUTO_TOTEM_ACTIVE: boolean = false
local AUTO_TOTEM_THREAD: thread? = nil
local selectedTotemName: string = "Luck Totem"
local currentTotemExpiry: number = 0
local lastSpawnPosition: Vector3? = nil

local TOTEM_DATA: {[string]: {Id: number, Duration: number}} = {
    ["Luck Totem"] = {Id = 1, Duration = 3601},
    ["Mutation Totem"] = {Id = 2, Duration = 3601},
    ["Shiny Totem"] = {Id = 3, Duration = 3601}
}

local TOTEM_NAMES: {string} = {"Luck Totem", "Mutation Totem", "Shiny Totem"}

-- =====================================================
-- AUTO FAVORITE/UNFAVORITE VARIABLES
-- =====================================================
local autoFavoriteState: boolean = false
local autoFavoriteThread: thread? = nil
local autoUnfavoriteState: boolean = false
local autoUnfavoriteThread: thread? = nil
local selectedRarities: {string} = {}
local selectedItemNames: {string} = {}
local selectedMutations: {string} = {}

-- UI Status Paragraph
local TOTEM_STATUS_PARAGRAPH: any = nil
local PlayerDataReplion = nil

-- =====================================================
-- ANTI-AFK
-- =====================================================
pcall(function()
    local player = LocalPlayer
    for _, v in pairs(getconnections(player.Idled)) do
        if v.Disable then
            v:Disable()
            print("[Plenger Hub Anti-AFK] ON")
        end
    end
end)

-- =====================================================
-- WINDOW CREATION
-- =====================================================
local Window = WindUI:CreateWindow({
    Title = "Plenger Hub - Fish It",
    Author = "Premium Version",
    Folder = "PlengerHub-FishIt",
    Icon = "rbxassetid://7733779610",
    Transparent = true,
    IconSize = 24,
    NewElements = true,
    Size = UDim2.fromOffset(600, 380),
    MinSize = Vector2.new(560, 250),
    MaxSize = Vector2.new(950, 760),
    ToggleKey = Enum.KeyCode.G,
    Resizable = true,
    SideBarWidth = 190,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = true,
    Theme = "Rose",
    User = {
        Enabled = true,
        Anonymous = false,
    },
    OpenButton = {
        Title = "Plenger Hub - Fish It",
        Icon = "rbxassetid://7733779610",
        CornerRadius = UDim.new(0, 30),
        StrokeThickness = 1.5,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false,
        Color = ColorSequence.new(
            Color3.fromHex("FF0F7B"),
            Color3.fromHex("F89B29")
        )
    },
    Topbar = {
        Height = 44,
        ButtonsType = "Default",
    },
})

-- =====================================================
-- AUTO FAVORITE/UNFAVORITE HELPER FUNCTIONS
-- =====================================================
local function GetPlayerDataReplion()
    if PlayerDataReplion then return PlayerDataReplion end
    
    local success, result = pcall(function()
        local ReplionModule = ReplicatedStorage:WaitForChild("Packages", 10):WaitForChild("Replion", 10)
        if not ReplionModule then 
            return nil 
        end
        
        local ReplionClient = require(ReplionModule).Client
        return ReplionClient:WaitReplion("Data", 5)
    end)
    
    if success and result then
        PlayerDataReplion = result
        print("[Plenger Hub] ‚úÖ PlayerDataReplion loaded")
    else
        warn("[Plenger Hub] ‚ùå PlayerDataReplion FAILED!")
    end
    
    return PlayerDataReplion
end

local function GetFishNameAndRarity(item: any): (string, string)
    local name = item.Identifier or "Unknown"
    local rarity = item.Metadata and item.Metadata.Rarity or "COMMON"
    local itemID = item.Id

    local itemData = nil

    if ItemUtility and itemID then
        pcall(function()
            itemData = ItemUtility:GetItemData(itemID)
            if not itemData then
                local numericID = tonumber(item.Id) or tonumber(item.Identifier)
                if numericID then
                    itemData = ItemUtility:GetItemData(numericID)
                end
            end
        end)
    end

    if itemData and itemData.Data and itemData.Data.Name then
        name = itemData.Data.Name
    end

    if item.Metadata and item.Metadata.Rarity then
        rarity = item.Metadata.Rarity
    elseif itemData and itemData.Probability and itemData.Probability.Chance and TierUtility then
        local tierObj = nil
        pcall(function()
            tierObj = TierUtility:GetTierFromRarity(itemData.Probability.Chance)
        end)

        if tierObj and tierObj.Name then
            rarity = tierObj.Name
        end
    end

    return name, rarity
end

local function GetItemMutationString(item: any): string
    if item.Metadata and item.Metadata.Shiny == true then 
        return "Shiny" 
    end
    return item.Metadata and item.Metadata.VariantId or ""
end

local function getAutoFavoriteItemOptions(): {string}
    local itemNames: {string} = {}
    local itemsContainer = ReplicatedStorage:FindFirstChild("Items")

    if not itemsContainer then
        return {"(Container 'Items' not found)"}
    end

    for _, itemObject in ipairs(itemsContainer:GetChildren()) do
        local itemName = itemObject.Name
        
        if type(itemName) == "string" and #itemName >= 3 then
            local prefix = itemName:sub(1, 3)
            
            if prefix ~= "!!!" then
                table.insert(itemNames, itemName)
            end
        end
    end

    table.sort(itemNames)
    
    if #itemNames == 0 then
        return {"(Container 'Items' is empty)"}
    end
    
    return itemNames
end

local function GetItemsToFavorite(): {string}
    local replion = GetPlayerDataReplion()
    if not replion then 
        return {} 
    end

    local success, inventoryData = pcall(function() 
        return replion:GetExpect("Inventory") 
    end)
    
    if not success or not inventoryData or not inventoryData.Items then 
        return {} 
    end

    local itemsToFavorite: {string} = {}
    
    local isRarityFilterActive = #selectedRarities > 0
    local isNameFilterActive = #selectedItemNames > 0
    local isMutationFilterActive = #selectedMutations > 0

    if not (isRarityFilterActive or isNameFilterActive or isMutationFilterActive) then
        return {}
    end

    for _, item in ipairs(inventoryData.Items) do
        if item.IsFavorite or item.Favorited then continue end
        
        local itemUUID = item.UUID
        if typeof(itemUUID) ~= "string" or itemUUID:len() < 10 then continue end
        
        local name, rarity = GetFishNameAndRarity(item)
        local mutationFilterString = GetItemMutationString(item)
        
        local isMatch = false

        if isRarityFilterActive and table.find(selectedRarities, rarity) then
            isMatch = true
        end

        if not isMatch and isNameFilterActive and table.find(selectedItemNames, name) then
            isMatch = true
        end

        if not isMatch and isMutationFilterActive and table.find(selectedMutations, mutationFilterString) then
            isMatch = true
        end

        if isMatch then
            table.insert(itemsToFavorite, itemUUID)
        end
    end

    return itemsToFavorite
end

local function GetItemsToUnfavorite(): {string}
    local replion = GetPlayerDataReplion()
    if not replion then 
        return {} 
    end

    local success, inventoryData = pcall(function() 
        return replion:GetExpect("Inventory") 
    end)
    
    if not success or not inventoryData or not inventoryData.Items then 
        return {} 
    end

    local itemsToUnfavorite: {string} = {}
    
    for _, item in ipairs(inventoryData.Items) do
        if not (item.IsFavorite or item.Favorited) then
            continue
        end
        
        local itemUUID = item.UUID
        if typeof(itemUUID) ~= "string" or itemUUID:len() < 10 then
            continue
        end
        
        local name, rarity = GetFishNameAndRarity(item)
        local mutationFilterString = GetItemMutationString(item)
        
        local passesRarity = #selectedRarities > 0 and table.find(selectedRarities, rarity)
        local passesName = #selectedItemNames > 0 and table.find(selectedItemNames, name)
        local passesMutation = #selectedMutations > 0 and table.find(selectedMutations, mutationFilterString)
        
        local isTargetedForUnfavorite = passesRarity or passesName or passesMutation
        
        if isTargetedForUnfavorite then
            table.insert(itemsToUnfavorite, itemUUID)
        end
    end

    return itemsToUnfavorite
end

local function SetItemFavoriteState(itemUUID: string): boolean
    if not RE_FavoriteItem then 
        return false 
    end
    
    local success = pcall(function() 
        RE_FavoriteItem:FireServer(itemUUID) 
    end)
    
    return success
end

local function RunAutoFavoriteLoop(): ()
    if autoFavoriteThread then task.cancel(autoFavoriteThread) end
    
    autoFavoriteThread = task.spawn(function()
        local waitTime = 2
        local actionDelay = 0.5
        
        while autoFavoriteState do
            local itemsToFavorite = GetItemsToFavorite()
            
            if #itemsToFavorite > 0 then
                WindUI:Notify({ 
                    Title = "Auto Favorite", 
                    Content = string.format("Favoriting %d items...", #itemsToFavorite), 
                    Duration = 2, 
                    Icon = "star" 
                })
                
                for _, itemUUID in ipairs(itemsToFavorite) do
                    SetItemFavoriteState(itemUUID)
                    task.wait(actionDelay)
                end
            end
            
            task.wait(waitTime)
        end
    end)
end

local function RunAutoUnfavoriteLoop(): ()
    if autoUnfavoriteThread then task.cancel(autoUnfavoriteThread) end
    
    autoUnfavoriteThread = task.spawn(function()
        local waitTime = 2
        local actionDelay = 0.5
        
        while autoUnfavoriteState do
            local itemsToUnfavorite = GetItemsToUnfavorite()
            
            if #itemsToUnfavorite > 0 then
                WindUI:Notify({ 
                    Title = "Auto Unfavorite", 
                    Content = string.format("Unfavoriting %d items...", #itemsToUnfavorite), 
                    Duration = 2, 
                    Icon = "x" 
                })
                
                for _, itemUUID in ipairs(itemsToUnfavorite) do
                    SetItemFavoriteState(itemUUID)
                    task.wait(actionDelay)
                end
            end
            
            task.wait(waitTime)
        end
    end)
end

-- =====================================================
-- BLATANT FISHING LOGIC
-- =====================================================

-- [1] CONTROLLER KILLER
task.spawn(function()
    local success, FishingController = pcall(function() 
        return require(ReplicatedStorage.Controllers.FishingController) 
    end)
    
    if success and FishingController then
        local Old_Charge = FishingController.RequestChargeFishingRod
        local Old_Cast = FishingController.SendFishingRequestToServer
        
        FishingController.RequestChargeFishingRod = function(...)
            if _G.PlengerHub_BlatantActive then 
                return 
            end 
            return Old_Charge(...)
        end
        
        FishingController.SendFishingRequestToServer = function(...)
            if _G.PlengerHub_BlatantActive then 
                return false, "Blocked by Plenger Hub" 
            end
            return Old_Cast(...)
        end
    end
end)

-- [2] REMOTE KILLER
local mt = getrawmetatable(game)
local old_namecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self: Instance, ...: any): any
    local method = getnamecallmethod()
    if _G.PlengerHub_BlatantActive and not checkcaller() then
        if method == "InvokeServer" and (
            self.Name == "RequestFishingMinigameStarted" or 
            self.Name == "ChargeFishingRod" or 
            self.Name == "UpdateAutoFishingState"
        ) then
            return nil 
        end
        if method == "FireServer" and self.Name == "FishingCompleted" then
            return nil
        end
    end
    return old_namecall(self, ...)
end)

setreadonly(mt, true)

-- [3] UI SPOOF
local function SuppressGameVisuals(active: boolean): ()
    local success, TextController = pcall(function() 
        return require(ReplicatedStorage.Controllers.TextNotificationController) 
    end)
    
    if success and TextController then
        if active then
            if not TextController._OldDeliver then 
                TextController._OldDeliver = TextController.DeliverNotification 
            end
            TextController.DeliverNotification = function(self, data)
                if data and data.Text and (
                    string.find(tostring(data.Text), "Auto Fishing") or 
                    string.find(tostring(data.Text), "Reach Level")
                ) then
                    return 
                end
                return TextController._OldDeliver(self, data)
            end
        elseif TextController._OldDeliver then
            TextController.DeliverNotification = TextController._OldDeliver
            TextController._OldDeliver = nil
        end
    end

    if active then
        task.spawn(function()
            local CollectionService = game:GetService("CollectionService")
            local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
            
            local InactiveColor = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromHex("ff5d60")), 
                ColorSequenceKeypoint.new(1, Color3.fromHex("ff2256"))
            })

            while _G.PlengerHub_BlatantActive do
                local targets: {Instance} = {}
                
                for _, btn in ipairs(CollectionService:GetTagged("AutoFishingButton")) do
                    table.insert(targets, btn)
                end
                
                if #targets == 0 then
                    local btn = PlayerGui:FindFirstChild("Backpack") 
                        and PlayerGui.Backpack:FindFirstChild("AutoFishingButton")
                    if btn then 
                        table.insert(targets, btn) 
                    end
                end

                for _, btn in ipairs(targets) do
                    local grad = btn:FindFirstChild("UIGradient")
                    if grad then
                        grad.Color = InactiveColor
                    end
                end
                
                RunService.RenderStepped:Wait()
            end
        end)
    end
end

-- [4] INSTANT FISH FUNCTION
local function runBlatantInstant(): ()
    if not blatantInstantState then 
        return 
    end
    
    task.spawn(function()
        local startTime: number = os.clock()
        local timestamp: number = os.time() + os.clock()
        
        pcall(function() 
            if RF_ChargeFishingRod then
                RF_ChargeFishingRod:InvokeServer(timestamp) 
            end
        end)
        task.wait(0.001)
        
        pcall(function() 
            if RF_RequestFishingMinigameStarted then
                RF_RequestFishingMinigameStarted:InvokeServer(-139.6379699707, 0.99647927980797) 
            end
        end)
        
        local completeWaitTime: number = completeDelay - (os.clock() - startTime)
        if completeWaitTime > 0 then 
            task.wait(completeWaitTime) 
        end
        
        pcall(function() 
            if RE_FishingCompleted then
                RE_FishingCompleted:FireServer() 
            end
        end)
        task.wait(cancelDelay)
        
        pcall(function() 
            if RF_CancelFishingInputs then
                RF_CancelFishingInputs:InvokeServer() 
            end
        end)
    end)
end

-- =====================================================
-- TOTEM LOGIC (PERSISTENT TIMER + AUTO DETECT NEW POSITION)
-- =====================================================
local function GetTotemUUID(name: string): string?
    local replion = GetPlayerDataReplion()
    if not replion then 
        return nil 
    end
    
    local success, inventoryData = pcall(function() 
        return replion:GetExpect("Inventory") 
    end)
    
    if success and inventoryData.Totems then 
        for _, item in ipairs(inventoryData.Totems) do 
            if tonumber(item.Id) == TOTEM_DATA[name].Id and (item.Count or 1) >= 1 then 
                return item.UUID 
            end 
        end 
    end
    
    return nil
end

local function UnequipAllItems(): ()
    if not RE_UnequipItem then return end
    
    local replion = GetPlayerDataReplion()
    if replion then
        local success, equippedItems = pcall(function() 
            return replion:GetExpect("EquippedItems") 
        end)
        
        if success and equippedItems then
            for _, uuid in ipairs(equippedItems) do
                pcall(function() 
                    RE_UnequipItem:FireServer(uuid) 
                end)
                task.wait(0.05)
            end
        end
    end
end

local function UpdateTotemStatus(title: string, content: string): ()
    if TOTEM_STATUS_PARAGRAPH then
        TOTEM_STATUS_PARAGRAPH:SetTitle(title)
        TOTEM_STATUS_PARAGRAPH:SetDesc(content)
    end
end

local function HasPlayerMoved(): boolean
    if not lastSpawnPosition then 
        return false 
    end
    
    local hrp = GetHRP()
    if not hrp then 
        return false 
    end
    
    local currentPos = hrp.Position
    local distance = (currentPos - lastSpawnPosition).Magnitude
    
    return distance > 50
end

local function SpawnTotemAtCurrentPosition(): boolean
    local uuid: string? = GetTotemUUID(selectedTotemName)
    
    if not uuid then
        UpdateTotemStatus("‚ùå Out of Stock", "No " .. selectedTotemName .. " found in inventory!")
        WindUI:Notify({
            Title = "Failed",
            Content = "No " .. selectedTotemName .. " available",
            Duration = 5,
            Icon = "alert-triangle"
        })
        return false
    end
    
    UpdateTotemStatus("üîß Preparing...", "Clearing equipped items...")
    UnequipAllItems()
    task.wait(0.3)
    
    UpdateTotemStatus("üì¶ Equipping...", "Equipping " .. selectedTotemName .. "...")
    pcall(function()
        if RE_EquipItem then
            RE_EquipItem:FireServer(uuid, "Totems")
        end
    end)
    task.wait(0.5)
    
    UpdateTotemStatus("üéØ Activating...", "Placing totem into hotbar slot 2...")
    pcall(function()
        if RE_EquipToolFromHotbar then
            RE_EquipToolFromHotbar:FireServer(2)
        end
    end)
    task.wait(0.8)
    
    UpdateTotemStatus("‚ú® Spawning...", "Spawning " .. selectedTotemName .. "...")
    pcall(function() 
        if RE_SpawnTotem then
            RE_SpawnTotem:FireServer(uuid) 
        end
    end)
    
    local hrp = GetHRP()
    if hrp then
        lastSpawnPosition = hrp.Position
    end
    
    currentTotemExpiry = os.time() + TOTEM_DATA[selectedTotemName].Duration
    
    task.spawn(function() 
        for i = 1, 3 do 
            task.wait(0.2) 
            pcall(function() 
                if RE_EquipToolFromHotbar then
                    RE_EquipToolFromHotbar:FireServer(1) 
                end
            end) 
        end 
    end)
    
    local spawnPos = lastSpawnPosition or Vector3.new(0,0,0)
    WindUI:Notify({
        Title = "Totem Spawned!",
        Content = string.format("%s placed at X:%.1f Y:%.1f Z:%.1f", 
            selectedTotemName, spawnPos.X, spawnPos.Y, spawnPos.Z),
        Duration = 3,
        Icon = "check"
    })
    
    return true
end

local function RunAutoTotemLoop(): ()
    if AUTO_TOTEM_THREAD then 
        task.cancel(AUTO_TOTEM_THREAD) 
    end
    
    AUTO_TOTEM_THREAD = task.spawn(function()
        local hrp = GetHRP()
        if hrp then
            local pos = hrp.Position
            UpdateTotemStatus(
                "üöÄ Initializing...",
                string.format("Preparing first spawn at: X:%.1f Y:%.1f Z:%.1f", pos.X, pos.Y, pos.Z)
            )
        end
        
        while AUTO_TOTEM_ACTIVE do
            local timeLeft: number = currentTotemExpiry - os.time()
            local hrp = GetHRP()
            local currentPos = hrp and hrp.Position or Vector3.new(0,0,0)
            
            if timeLeft > 0 then
                local minutes: number = math.floor((timeLeft % 3600) / 60)
                local seconds: number = math.floor(timeLeft % 60)
                
                if HasPlayerMoved() then
                    UpdateTotemStatus(
                        string.format("‚è≥ %s Active (Moved)", selectedTotemName),
                        string.format("Next Spawn: %02d:%02d\nüìç New Position: X:%.1f Y:%.1f Z:%.1f\n‚ö†Ô∏è Totem will spawn here when timer ends!", 
                            minutes, seconds, currentPos.X, currentPos.Y, currentPos.Z)
                    )
                else
                    UpdateTotemStatus(
                        string.format("‚è≥ %s Active", selectedTotemName),
                        string.format("Next Spawn: %02d:%02d\nüìç Current: X:%.1f Y:%.1f Z:%.1f", 
                            minutes, seconds, currentPos.X, currentPos.Y, currentPos.Z)
                    )
                end
            else
                UpdateTotemStatus("üîç Checking...", "Searching for " .. selectedTotemName .. " in inventory...")
                
                local spawnSuccess = SpawnTotemAtCurrentPosition()
                
                if not spawnSuccess then
                    task.wait(10)
                end
            end
            
            task.wait(1)
        end
    end)
end

-- =====================================================
-- UI CREATION - FISHING TAB
-- =====================================================
local farm = Window:Tab({
    Title = "Fishing",
    Icon = "fish",
    Locked = false,
})

local blatant = farm:Section({
    Title = "Blatant Mode",
    TextSize = 20,
})

local LoopIntervalInput = blatant:Input({
    Title = "Blatant Interval",
    Value = tostring(loopInterval),
    Icon = "fast-forward",
    Type = "Input",
    Placeholder = "1.58",
    Callback = function(input: string)
        local newInterval: number? = tonumber(input)
        if newInterval and newInterval >= 0.5 then 
            loopInterval = newInterval 
        end
    end
})

local CompleteDelayInput = blatant:Input({
    Title = "Complete Delay",
    Value = tostring(completeDelay),
    Icon = "loader",
    Type = "Input",
    Placeholder = "2.75",
    Callback = function(input: string)
        local newDelay: number? = tonumber(input)
        if newDelay and newDelay >= 0.5 then 
            completeDelay = newDelay 
        end
    end
})

local CancelDelayInput = blatant:Input({
    Title = "Cancel Delay",
    Value = tostring(cancelDelay),
    Icon = "clock",
    Type = "Input",
    Placeholder = "0.3",
    Callback = function(input: string)
        local newDelay: number? = tonumber(input)
        if newDelay and newDelay >= 0.1 then 
            cancelDelay = newDelay 
        end
    end
})

local togblat = blatant:Toggle({
    Title = "Instant Fishing (Blatant)",
    Value = false,
    Callback = function(state: boolean)
        blatantInstantState = state
        _G.PlengerHub_BlatantActive = state
        
        SuppressGameVisuals(state)
        
        if state then
            if RF_UpdateAutoFishingState then
                pcall(function() RF_UpdateAutoFishingState:InvokeServer(true) end)
                task.wait(0.5)
                pcall(function() RF_UpdateAutoFishingState:InvokeServer(true) end)
                pcall(function() RF_UpdateAutoFishingState:InvokeServer(true) end)
            end

            blatantLoopThread = task.spawn(function()
                while blatantInstantState do
                    runBlatantInstant()
                    task.wait(loopInterval)
                end
            end)

            if blatantEquipThread then 
                task.cancel(blatantEquipThread) 
            end
            
            blatantEquipThread = task.spawn(function()
                while blatantInstantState do
                    pcall(function() 
                        if RE_EquipToolFromHotbar then
                            RE_EquipToolFromHotbar:FireServer(1) 
                        end
                    end)
                    task.wait(0.1) 
                end
            end)
            
            WindUI:Notify({
                Title = "Blatant Mode ON",
                Duration = 3,
                Icon = "zap"
            })
        else
            if RF_UpdateAutoFishingState then
                pcall(function() RF_UpdateAutoFishingState:InvokeServer(false) end)
            end

            if blatantLoopThread then 
                task.cancel(blatantLoopThread) 
                blatantLoopThread = nil 
            end
            
            if blatantEquipThread then 
                task.cancel(blatantEquipThread) 
                blatantEquipThread = nil 
            end
            
            WindUI:Notify({
                Title = "Stopped",
                Duration = 2
            })
        end
    end
})

-- =====================================================
-- UI CREATION - AUTO FAVORITE TAB
-- =====================================================
local automatic = Window:Tab({
    Title = "Auto Favorite",
    Icon = "star",
    IconColor = Color3.fromHex("#FFD700"),
    IconShape = true,
    Locked = false,
})

local favsec = automatic:Section({ 
    Title = "Auto Favorite / Unfavorite", 
    TextSize = 20 
})

favsec:Paragraph({
    Title = "‚ö†Ô∏è Utilities Status",
    Content = UtilitiesLoaded and "‚úÖ Loaded successfully!" or "‚è≥ Loading... Please wait or click Retry button below",
    Icon = "info"
})

favsec:Button({
    Title = "Retry Load Utilities",
    Icon = "refresh-cw",
    Desc = "Click if utilities failed to load",
    Callback = function()
        WindUI:Notify({
            Title = "Retrying...",
            Content = "Attempting to load utilities...",
            Duration = 2,
            Icon = "loader"
        })
        
        task.spawn(function()
            if LoadUtilitiesWithRetry() then
                WindUI:Notify({
                    Title = "Success!",
                    Content = "Utilities loaded successfully!",
                    Duration = 3,
                    Icon = "check"
                })
            else
                WindUI:Notify({
                    Title = "Failed",
                    Content = "Could not load utilities. Feature may not work properly.",
                    Duration = 5,
                    Icon = "x"
                })
            end
        end)
    end
})

automatic:Divider()

-- 1. DROPDOWN FILTER BY RARITY (Multi-Select)
local RarityDropdown = favsec:Dropdown({
    Title = "Filter by Rarity",
    Values = {"COMMON", "UNCOMMON", "RARE", "EPIC", "LEGENDARY", "MYTHIC", "SECRET"},
    Multi = true, 
    AllowNone = true, 
    Value = false,
    Callback = function(values: {string}) 
        selectedRarities = values or {} 
    end
})

-- 2. DROPDOWN FILTER BY ITEM NAME (Multi-Select)
local allItemNames = getAutoFavoriteItemOptions()

local ItemNameDropdown = favsec:Dropdown({
    Title = "Filter by Item Name",
    Values = allItemNames,
    Multi = true, 
    AllowNone = true, 
    Value = false,
    Callback = function(values: {string}) 
        selectedItemNames = values or {} 
    end
})

-- 3. DROPDOWN FILTER BY MUTATION (Multi-Select)
local MutationDropdown = favsec:Dropdown({
    Title = "Filter by Mutation/Variant",
    Values = {"Shiny", "VariantId"},
    Multi = true, 
    AllowNone = true, 
    Value = false,
    Callback = function(values: {string}) 
        selectedMutations = values or {} 
    end
})

automatic:Divider()

-- 4. TOGGLE AUTO FAVORITE
local togglefav = favsec:Toggle({
    Title = "Enable Auto Favorite",
    Desc = "Automatically favorite items based on filters",
    Value = false,
    Callback = function(state: boolean)
        autoFavoriteState = state
        
        if state then
            if autoUnfavoriteState then
                autoUnfavoriteState = false
                if autoUnfavoriteThread then 
                    task.cancel(autoUnfavoriteThread) 
                    autoUnfavoriteThread = nil 
                end
            end

            if not GetPlayerDataReplion() then 
                WindUI:Notify({ 
                    Title = "Error", 
                    Content = "Failed to load Replion data. Wait and try again.", 
                    Duration = 3, 
                    Icon = "x" 
                })
                return false 
            end
            
            if not UtilitiesLoaded then
                WindUI:Notify({ 
                    Title = "Warning", 
                    Content = "Utilities not loaded. Click Retry button first!", 
                    Duration = 5, 
                    Icon = "alert-triangle" 
                })
                return false
            end
            
            WindUI:Notify({ 
                Title = "Auto Favorite ON!", 
                Duration = 3, 
                Icon = "check" 
            })
            
            RunAutoFavoriteLoop()
        else
            WindUI:Notify({ 
                Title = "Auto Favorite OFF!", 
                Duration = 3, 
                Icon = "x" 
            })
            
            if autoFavoriteThread then 
                task.cancel(autoFavoriteThread) 
                autoFavoriteThread = nil 
            end
        end
    end
})

-- 5. TOGGLE AUTO UNFAVORITE
local toggleunfav = favsec:Toggle({
    Title = "Enable Auto Unfavorite",
    Desc = "Automatically unfavorite items based on filters",
    Value = false,
    Callback = function(state: boolean)
        autoUnfavoriteState = state
        
        if state then
            if autoFavoriteState then
                autoFavoriteState = false
                if autoFavoriteThread then 
                    task.cancel(autoFavoriteThread) 
                    autoFavoriteThread = nil 
                end
            end
            
            if #selectedRarities == 0 and #selectedItemNames == 0 and #selectedMutations == 0 then
                WindUI:Notify({ 
                    Title = "Warning!", 
                    Content = "All filters are empty. Please select at least one filter.", 
                    Duration = 5, 
                    Icon = "alert-triangle" 
                })
                return false
            end

            if not GetPlayerDataReplion() then 
                WindUI:Notify({ 
                    Title = "Error", 
                    Content = "Failed to load Replion data. Wait and try again.", 
                    Duration = 3, 
                    Icon = "x" 
                })
                return false 
            end

            if not UtilitiesLoaded then
                WindUI:Notify({ 
                    Title = "Warning", 
                    Content = "Utilities not loaded. Click Retry button first!", 
                    Duration = 5, 
                    Icon = "alert-triangle" 
                })
                return false
            end

            WindUI:Notify({ 
                Title = "Auto Unfavorite ON!", 
                Content = "Unfavoriting selected items.", 
                Duration = 3, 
                Icon = "check" 
            })
            
            RunAutoUnfavoriteLoop()
        else
            WindUI:Notify({ 
                Title = "Auto Unfavorite OFF!", 
                Duration = 3, 
                Icon = "x" 
            })
            
            if autoUnfavoriteThread then 
                task.cancel(autoUnfavoriteThread) 
                autoUnfavoriteThread = nil 
            end
        end
    end
})

-- =====================================================
-- UI CREATION - PREMIUM TAB
-- =====================================================
local premium = Window:Tab({
    Title = "Premium",
    Icon = "star",
    IconColor = Color3.fromHex("#42f5b9"),
    IconShape = true,
    Locked = false,
})

local totem = premium:Section({
    Title = "Auto Spawn Totem",
    TextSize = 20
})

premium:Divider()

TOTEM_STATUS_PARAGRAPH = totem:Paragraph({
    Title = "üí§ Status: Idle",
    Content = "Aktifkan toggle untuk spawn totem.\n\n‚ú® Timer tidak terpengaruh perpindahan tempat!\nüìç Totem spawn di posisi terbaru saat timer habis.",
    Icon = "clock"
})

local choosetot = totem:Dropdown({
    Title = "Pilih Jenis Totem",
    Values = TOTEM_NAMES,
    Value = selectedTotemName,
    Multi = false,
    Callback = function(name: string)
        selectedTotemName = name
        currentTotemExpiry = 0
        lastSpawnPosition = nil
        
        UpdateTotemStatus(
            "üîÑ Changed Target",
            "Switched to " .. name .. "\nTimer reset."
        )
    end
})

local togtot = totem:Toggle({
    Title = "Enable Auto Totem (Smart)",
    Desc = "Timer persistent + auto detect posisi baru",
    Value = false,
    Callback = function(state: boolean)
        AUTO_TOTEM_ACTIVE = state
        if state then
            RunAutoTotemLoop()
            WindUI:Notify({
                Title = "Auto Totem Started",
                Content = "Timer berjalan terus meskipun kamu pindah tempat!",
                Duration = 3,
                Icon = "play"
            })
        else
            if AUTO_TOTEM_THREAD then 
                task.cancel(AUTO_TOTEM_THREAD) 
                AUTO_TOTEM_THREAD = nil
            end
            
            UpdateTotemStatus(
                "‚èπÔ∏è Stopped",
                "Auto Totem telah dinonaktifkan.\nTimer direset."
            )
            
            currentTotemExpiry = 0
            lastSpawnPosition = nil
            
            WindUI:Notify({
                Title = "Auto Totem Stopped",
                Duration = 2,
                Icon = "square"
            })
        end
    end
})

totem:Button({
    Title = "Manual Spawn at Current Position",
    Icon = "zap",
    Desc = "Spawn sekali + reset timer",
    Callback = function()
        local success = SpawnTotemAtCurrentPosition()
        if success then
            WindUI:Notify({
                Title = "Manual Spawn Success",
                Content = "Timer direset ke 60 menit",
                Duration = 3,
                Icon = "check"
            })
        end
    end
})

totem:Button({
    Title = "Reset Timer",
    Icon = "refresh-cw",
    Desc = "Reset countdown tanpa spawn",
    Callback = function()
        currentTotemExpiry = 0
        lastSpawnPosition = nil
        
        UpdateTotemStatus(
            "üîÑ Timer Reset",
            "Timer di-reset. Siap spawn ulang!"
        )
        
        WindUI:Notify({
            Title = "Timer Reset",
            Content = "Countdown direset ke 0",
            Duration = 2,
            Icon = "rotate-ccw"
        })
    end
})

-- =====================================================
-- FINALIZATION
-- =====================================================
Window:Tag({
    Title = "Delta V1.5",
    Color = Color3.fromHex("#F5C527"),
    Radius = 9,
})

WindUI:Notify({
    Title = "Plenger Hub Delta V1.5",
    Content = "Auto Favorite ready for Delta!",
    Duration = 5,
    Icon = "info"
})

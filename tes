local WindUI

do
    local ok, result = pcall(function()
        return require("./src/Init")
    end)
    
    if ok then
        WindUI = result
    else 
        WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
    end
end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local RPath = {"Packages", "_Index", "sleitnick_net@0.2.0", "net"}
local function GetRemote(remotePath, name)
    local currentInstance = ReplicatedStorage
    for _, childName in ipairs(remotePath) do
        local child = currentInstance:WaitForChild(childName, 0.5)
        if not child then 
            return nil 
        end
        currentInstance = child
    end
    return currentInstance:FindFirstChild(name)
end

local Vars = {
    R = {
        EquipTool = GetRemote(RPath, "RE/EquipToolFromHotbar"),
        SpawnTotem = GetRemote(RPath, "RE/SpawnTotem"),
        EquipItem = GetRemote(RPath, "RE/EquipItem"),
        UnequipItem = GetRemote(RPath, "RE/UnequipItem")
    },
    T = { 
        Active = false,
        Thread = nil,
        Name = nil,
        Expiry = 0
    },
    Totems = {
        Data = {
            ["Luck Totem"] = {Id = 1, Duration = 3601},
            ["Mutation Totem"] = {Id = 2, Duration = 3601},
            ["Shiny Totem"] = {Id = 3, Duration = 3601}
        },
        Names = {"Luck Totem", "Mutation Totem", "Shiny Totem"}
    }
}

local Window = WindUI:CreateWindow({
    Title = "LS Hub - Fish It",
    Author = "developed by Louissxe",
    Folder = "LSHub-FishIt",
    Icon = "rbxassetid://129609617845057",
    Transparent = true,
    IconSize = 12*2,
    NewElements = true,
    Size = UDim2.fromOffset(580, 380),
    ToggleKey = Enum.KeyCode.G,
    User = {
        Enabled = true,
        Anonymous = true,
    },
    HideSearchBar = false,
    OpenButton = {
        Title = "Open LS Hub",
        CornerRadius = UDim.new(0.3,0),
        StrokeThickness = 3,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false,
        Color = ColorSequence.new(
            Color3.fromRGB(107, 49, 255), 
            Color3.fromRGB(215, 48, 221)
        )
    },
    Topbar = {
        Height = 44,
        ButtonsType = "Default",
    },
})

local function GetPlayerDataReplion()
    local ReplionModule = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Replion", 10)
    if not ReplionModule then 
        return nil 
    end
    local ReplionClient = require(ReplionModule).Client
    return ReplionClient:WaitReplion("Data", 5)
end

local function GetTotemUUID(name)
    local replion = GetPlayerDataReplion()
    if not replion then 
        return nil 
    end
    
    local success, inventoryData = pcall(function() 
        return replion:GetExpect("Inventory") 
    end)
    
    if success and inventoryData.Totems then 
        for _, item in ipairs(inventoryData.Totems) do 
            if tonumber(item.Id) == Vars.Totems.Data[name].Id and (item.Count or 1) >= 1 then 
                return item.UUID 
            end 
        end 
    end
    
    return nil
end

local function UnequipAllItems()
    if not Vars.R.UnequipItem then return end
    
    local replion = GetPlayerDataReplion()
    if replion then
        local success, equippedItems = pcall(function() 
            return replion:GetExpect("EquippedItems") 
        end)
        
        if success and equippedItems then
            for _, uuid in ipairs(equippedItems) do
                pcall(function() 
                    Vars.R.UnequipItem:FireServer(uuid) 
                end)
                task.wait(0.05)
            end
        end
    end
end

local function SpawnTotem()
    local uuid = GetTotemUUID(Vars.T.Name)
    
    if not uuid then
        WindUI:Notify({
            Title = "Failed",
            Content = "No " .. Vars.T.Name .. " available",
            Duration = 5,
            Icon = "alert-triangle"
        })
        return false
    end
    
    UnequipAllItems()
    task.wait(0.3)
    
    pcall(function()
        if Vars.R.EquipItem then
            Vars.R.EquipItem:FireServer(uuid, "Totems")
        end
    end)
    task.wait(0.5)
    
    pcall(function()
        if Vars.R.EquipTool then
            Vars.R.EquipTool:FireServer(2)
        end
    end)
    task.wait(0.8)
    
    pcall(function() 
        if Vars.R.SpawnTotem then
            Vars.R.SpawnTotem:FireServer(uuid) 
        end
    end)
    
    Vars.T.Expiry = os.time() + Vars.Totems.Data[Vars.T.Name].Duration
    
    task.spawn(function() 
        for i = 1, 3 do 
            task.wait(0.2) 
            pcall(function() 
                if Vars.R.EquipTool then
                    Vars.R.EquipTool:FireServer(1) 
                end
            end) 
        end 
    end)
    
    WindUI:Notify({
        Title = "Totem Spawned!",
        Content = Vars.T.Name .. " placed successfully",
        Duration = 3,
        Icon = "check"
    })
    
    return true
end

local function RunAutoTotemLoop()
    if Vars.T.Thread then 
        task.cancel(Vars.T.Thread) 
    end
    
    Vars.T.Thread = task.spawn(function()
        while Vars.T.Active do
            local timeLeft = Vars.T.Expiry - os.time()
            
            if timeLeft <= 0 then
                SpawnTotem()
                if Vars.T.Active then
                    task.wait(10)
                end
            else
                task.wait(1)
            end
        end
    end)
end

local premium = Window:Tab({
    Title = "Webhook Settings",
    Icon = "solar:golf-bold",
    IconColor = Color3.fromHex("#42f5b9"),
    IconShape = true,
})

local totem = premium:Section({
    Title = "Auto Spawn Totem"
})

premium:Divider()

local choosetot = totem:Dropdown({
    Title = "Pilih Jenis Totem",
    Values = Vars.Totems.Names,
    Value = Vars.T.Name,
    Multi = false,
    Callback = function(name)
        Vars.T.Name = name
        Vars.T.Expiry = 0
        
        WindUI:Notify({
            Title = "Totem Changed",
            Content = "Switched to " .. name,
            Duration = 2,
            Icon = "info"
        })
    end
})

local togtot = totem:Toggle({
    Title = "Enable Auto Totem",
    Desc = "Auto spawn totem setiap 60 menit",
    Value = false,
    Callback = function(state)
        Vars.T.Active = state
        if state then
            RunAutoTotemLoop()
            WindUI:Notify({
                Title = "Auto Totem Started",
                Duration = 3,
                Icon = "play"
            })
        else
            if Vars.T.Thread then 
                task.cancel(Vars.T.Thread) 
                Vars.T.Thread = nil
            end
            
            WindUI:Notify({
                Title = "Auto Totem Stopped",
                Duration = 2,
                Icon = "square"
            })
        end
    end
})

totem:Button({
    Title = "Manualy Spawn Totem",
    Icon = "zap",
    Callback = function()
        SpawnTotem()
    end
})

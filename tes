--!strict
-- Plenger Hub Premium - Optimized & Fixed
local W

do
    local ok, r = pcall(function()
        return require("./src/Init")
    end)
    
    if ok then
        W = r
    else 
        W = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
    end
end

-- Services
local P = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local Run = game:GetService("RunService")
local LP = P.LocalPlayer
local RP = {"Packages", "_Index", "sleitnick_net@0.2.0", "net"}

-- Helper
local function GR(rp, n, t)
    local c = RS
    for _, cn in ipairs(rp) do
        local ch = c:WaitForChild(cn, t or 0.5)
        if not ch then return nil end
        c = ch
    end
    return c:FindFirstChild(n)
end

local function GHRP()
    local C = LP.Character
    if not C then C = LP.CharacterAdded:Wait() end
    return C:WaitForChild("HumanoidRootPart", 5)
end

-- Remotes
local R1 = GR(RP, "RE/EquipToolFromHotbar")
local R2 = GR(RP, "RF/ChargeFishingRod")
local R3 = GR(RP, "RF/RequestFishingMinigameStarted")
local R4 = GR(RP, "RE/FishingCompleted")
local R5 = GR(RP, "RF/CancelFishingInputs")
local R6 = GR(RP, "RF/UpdateAutoFishingState")
local R7 = GR(RP, "RE/SpawnTotem")
local R8 = GR(RP, "RE/EquipItem")
local R9 = GR(RP, "RE/UnequipItem")
local R10 = GR(RP, "RE/FavoriteItem")

-- Utilities
local IU, TU, UL = nil, nil, false

local function LU()
    local tries = {
        function()
            local S = RS:WaitForChild("Shared", 5)
            if S then
                IU = require(S:WaitForChild("ItemUtility", 3))
                TU = require(S:WaitForChild("TierUtility", 3))
                return true
            end
            return false
        end,
        function()
            for _, d in ipairs(RS:GetDescendants()) do
                if d.Name == "ItemUtility" and d:IsA("ModuleScript") then
                    IU = require(d)
                end
                if d.Name == "TierUtility" and d:IsA("ModuleScript") then
                    TU = require(d)
                end
                if IU and TU then return true end
            end
            return false
        end
    }
    
    for i, tf in ipairs(tries) do
        local ok = pcall(function()
            if tf() then
                UL = true
                print("[PH] ‚úÖ Utils loaded (Try " .. i .. ")")
                return true
            end
        end)
        if ok and UL then return true end
        task.wait(0.3)
    end
    return false
end

task.spawn(function()
    task.wait(1)
    LU()
end)

-- Variables
local BS, BLT, BET = false, nil, nil
local CD, CaD, LI = 3.055, 0.3, 1.715
_G.PH_BA = false

local ATA, ATT, STN = false, nil, "Luck Totem"
local CTE, LSP = 0, nil
local TD = {
    ["Luck Totem"] = {Id = 1, Duration = 3601},
    ["Mutation Totem"] = {Id = 2, Duration = 3601},
    ["Shiny Totem"] = {Id = 3, Duration = 3601}
}
local TN = {"Luck Totem", "Mutation Totem", "Shiny Totem"}

local AFS, AFT, AUFS, AUFT = false, nil, false, nil
local SR, SN, SM = {}, {}, {}
local TSP, PDR = nil, nil

-- Anti-AFK
pcall(function()
    for _, v in pairs(getconnections(LP.Idled)) do
        if v.Disable then v:Disable() end
    end
end)

-- Window
local Win = W:CreateWindow({
    Title = "Plenger Hub - Fish It",
    Author = "Premium",
    Folder = "PlengerHub",
    Icon = "rbxassetid://7733779610",
    Transparent = true,
    IconSize = 24,
    NewElements = true,
    Size = UDim2.fromOffset(600, 380),
    MinSize = Vector2.new(560, 250),
    MaxSize = Vector2.new(950, 760),
    ToggleKey = Enum.KeyCode.G,
    Resizable = true,
    SideBarWidth = 190,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = true,
    Theme = "Rose",
    User = {Enabled = true, Anonymous = false},
    OpenButton = {
        Title = "Plenger Hub",
        Icon = "rbxassetid://7733779610",
        CornerRadius = UDim.new(0, 30),
        StrokeThickness = 1.5,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false,
        Color = ColorSequence.new(Color3.fromHex("FF0F7B"), Color3.fromHex("F89B29"))
    },
    Topbar = {Height = 44, ButtonsType = "Default"}
})

-- Auto Favorite Functions
local function GPDR()
    if PDR then return PDR end
    local ok, r = pcall(function()
        local RM = RS:WaitForChild("Packages", 10):WaitForChild("Replion", 10)
        if not RM then return nil end
        local RC = require(RM).Client
        return RC:WaitReplion("Data", 5)
    end)
    if ok and r then
        PDR = r
        print("[PH] ‚úÖ Replion OK")
    end
    return PDR
end

local function GFNR(itm)
    local nm = itm.Identifier or "Unknown"
    local rt = "COMMON"
    
    -- Priority 1: Direct metadata
    if itm.Metadata and itm.Metadata.Rarity then
        rt = tostring(itm.Metadata.Rarity):upper()
        return nm, rt
    end
    
    -- Priority 2: ItemUtility lookup
    if IU and itm.Id then
        local idata = nil
        pcall(function()
            idata = IU:GetItemData(itm.Id)
            if not idata then
                local nid = tonumber(itm.Id) or tonumber(itm.Identifier)
                if nid then idata = IU:GetItemData(nid) end
            end
        end)
        
        if idata then
            if idata.Data and idata.Data.Name then
                nm = idata.Data.Name
            end
            
            if idata.Probability and idata.Probability.Chance and TU then
                pcall(function()
                    local to = TU:GetTierFromRarity(idata.Probability.Chance)
                    if to and to.Name then
                        rt = tostring(to.Name):upper()
                    end
                end)
            end
        end
    end
    
    return nm, rt
end

local function GIMS(itm)
    if itm.Metadata and itm.Metadata.Shiny == true then 
        return "Shiny" 
    end
    return itm.Metadata and tostring(itm.Metadata.VariantId) or ""
end

local function GAIO()
    local ins = {}
    local ic = RS:FindFirstChild("Items")
    if not ic then return {"(No Items)"} end
    
    for _, io in ipairs(ic:GetChildren()) do
        local in_ = io.Name
        if type(in_) == "string" and #in_ >= 3 and in_:sub(1, 3) ~= "!!!" then
            table.insert(ins, in_)
        end
    end
    
    table.sort(ins)
    return #ins == 0 and {"(Empty)"} or ins
end

local function GITF()
    local rep = GPDR()
    if not rep then return {} end
    
    local ok, inv = pcall(function() return rep:GetExpect("Inventory") end)
    if not ok or not inv or not inv.Items then return {} end
    
    local itf = {}
    local rfa = #SR > 0
    local nfa = #SN > 0
    local mfa = #SM > 0
    
    if not (rfa or nfa or mfa) then return {} end
    
    for _, itm in ipairs(inv.Items) do
        if itm.IsFavorite or itm.Favorited then continue end
        
        local uuid = itm.UUID
        if typeof(uuid) ~= "string" or uuid:len() < 10 then continue end
        
        local nm, rt = GFNR(itm)
        local ms = GIMS(itm)
        
        local match = false
        
        -- Check rarity - FIXED: proper string comparison
        if rfa then
            for _, selRar in ipairs(SR) do
                if rt == tostring(selRar):upper() then
                    match = true
                    break
                end
            end
        end
        
        -- Check name
        if not match and nfa and table.find(SN, nm) then
            match = true
        end
        
        -- Check mutation
        if not match and mfa then
            for _, selMut in ipairs(SM) do
                if string.find(ms, selMut) then
                    match = true
                    break
                end
            end
        end
        
        if match then
            table.insert(itf, uuid)
        end
    end
    
    return itf
end

local function GITU()
    local rep = GPDR()
    if not rep then return {} end
    
    local ok, inv = pcall(function() return rep:GetExpect("Inventory") end)
    if not ok or not inv or not inv.Items then return {} end
    
    local itu = {}
    
    for _, itm in ipairs(inv.Items) do
        if not (itm.IsFavorite or itm.Favorited) then continue end
        
        local uuid = itm.UUID
        if typeof(uuid) ~= "string" or uuid:len() < 10 then continue end
        
        local nm, rt = GFNR(itm)
        local ms = GIMS(itm)
        
        local pr, pn, pm = false, false, false
        
        if #SR > 0 then
            for _, selRar in ipairs(SR) do
                if rt == tostring(selRar):upper() then
                    pr = true
                    break
                end
            end
        end
        
        pn = #SN > 0 and table.find(SN, nm)
        
        if #SM > 0 then
            for _, selMut in ipairs(SM) do
                if string.find(ms, selMut) then
                    pm = true
                    break
                end
            end
        end
        
        if pr or pn or pm then
            table.insert(itu, uuid)
        end
    end
    
    return itu
end

local function SIFS(uuid)
    if not R10 then return false end
    return pcall(function() R10:FireServer(uuid) end)
end

local function RAFL()
    if AFT then task.cancel(AFT) end
    AFT = task.spawn(function()
        while AFS do
            local itf = GITF()
            if #itf > 0 then
                W:Notify({Title = "Auto Fav", Content = #itf .. " items", Duration = 2, Icon = "star"})
                for _, uuid in ipairs(itf) do
                    SIFS(uuid)
                    task.wait(0.5)
                end
            end
            task.wait(2)
        end
    end)
end

local function RAUL()
    if AUFT then task.cancel(AUFT) end
    AUFT = task.spawn(function()
        while AUFS do
            local itu = GITU()
            if #itu > 0 then
                W:Notify({Title = "Auto Unfav", Content = #itu .. " items", Duration = 2, Icon = "x"})
                for _, uuid in ipairs(itu) do
                    SIFS(uuid)
                    task.wait(0.5)
                end
            end
            task.wait(2)
        end
    end)
end

-- Blatant Fishing
task.spawn(function()
    local ok, FC = pcall(function() return require(RS.Controllers.FishingController) end)
    if ok and FC then
        local OC = FC.RequestChargeFishingRod
        local OCa = FC.SendFishingRequestToServer
        FC.RequestChargeFishingRod = function(...) if _G.PH_BA then return end return OC(...) end
        FC.SendFishingRequestToServer = function(...) if _G.PH_BA then return false, "Blocked" end return OCa(...) end
    end
end)

local mt = getrawmetatable(game)
local onc = mt.__namecall
setreadonly(mt, false)
mt.__namecall = newcclosure(function(s, ...)
    local m = getnamecallmethod()
    if _G.PH_BA and not checkcaller() then
        if m == "InvokeServer" and (s.Name == "RequestFishingMinigameStarted" or s.Name == "ChargeFishingRod" or s.Name == "UpdateAutoFishingState") then
            return nil
        end
        if m == "FireServer" and s.Name == "FishingCompleted" then
            return nil
        end
    end
    return onc(s, ...)
end)
setreadonly(mt, true)

local function SGV(a)
    local ok, TC = pcall(function() return require(RS.Controllers.TextNotificationController) end)
    if ok and TC then
        if a then
            if not TC._OD then TC._OD = TC.DeliverNotification end
            TC.DeliverNotification = function(se, d)
                if d and d.Text and (string.find(tostring(d.Text), "Auto Fishing") or string.find(tostring(d.Text), "Reach Level")) then
                    return
                end
                return TC._OD(se, d)
            end
        elseif TC._OD then
            TC.DeliverNotification = TC._OD
            TC._OD = nil
        end
    end
    
    if a then
        task.spawn(function()
            local CS = game:GetService("CollectionService")
            local PG = LP:WaitForChild("PlayerGui")
            local IC = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromHex("ff5d60")),
                ColorSequenceKeypoint.new(1, Color3.fromHex("ff2256"))
            })
            while _G.PH_BA do
                local tg = {}
                for _, b in ipairs(CS:GetTagged("AutoFishingButton")) do
                    table.insert(tg, b)
                end
                if #tg == 0 then
                    local b = PG:FindFirstChild("Backpack") and PG.Backpack:FindFirstChild("AutoFishingButton")
                    if b then table.insert(tg, b) end
                end
                for _, b in ipairs(tg) do
                    local g = b:FindFirstChild("UIGradient")
                    if g then g.Color = IC end
                end
                Run.RenderStepped:Wait()
            end
        end)
    end
end

local function RBI()
    if not BS then return end
    task.spawn(function()
        local st = os.clock()
        local ts = os.time() + os.clock()
        pcall(function() if R2 then R2:InvokeServer(ts) end end)
        task.wait(0.001)
        pcall(function() if R3 then R3:InvokeServer(-139.6379699707, 0.99647927980797) end end)
        local cw = CD - (os.clock() - st)
        if cw > 0 then task.wait(cw) end
        pcall(function() if R4 then R4:FireServer() end end)
        task.wait(CaD)
        pcall(function() if R5 then R5:InvokeServer() end end)
    end)
end

-- Totem
local function GTU(n)
    local rep = GPDR()
    if not rep then return nil end
    local ok, inv = pcall(function() return rep:GetExpect("Inventory") end)
    if ok and inv.Totems then
        for _, itm in ipairs(inv.Totems) do
            if tonumber(itm.Id) == TD[n].Id and (itm.Count or 1) >= 1 then
                return itm.UUID
            end
        end
    end
    return nil
end

local function UAI()
    if not R9 then return end
    local rep = GPDR()
    if rep then
        local ok, eq = pcall(function() return rep:GetExpect("EquippedItems") end)
        if ok and eq then
            for _, uuid in ipairs(eq) do
                pcall(function() R9:FireServer(uuid) end)
                task.wait(0.05)
            end
        end
    end
end

local function UTS(t, c)
    if TSP then
        TSP:SetTitle(t)
        TSP:SetDesc(c)
    end
end

local function HPM()
    if not LSP then return false end
    local hrp = GHRP()
    if not hrp then return false end
    return (hrp.Position - LSP).Magnitude > 50
end

local function STCP()
    local uuid = GTU(STN)
    if not uuid then
        UTS("‚ùå No Stock", "No " .. STN .. " found!")
        W:Notify({Title = "Failed", Content = "No " .. STN, Duration = 5, Icon = "alert-triangle"})
        return false
    end
    
    UTS("üîß Prep...", "Clearing...")
    UAI()
    task.wait(0.3)
    UTS("üì¶ Equip...", "Equipping " .. STN)
    pcall(function() if R8 then R8:FireServer(uuid, "Totems") end end)
    task.wait(0.5)
    UTS("üéØ Active...", "Hotbar slot 2")
    pcall(function() if R1 then R1:FireServer(2) end end)
    task.wait(0.8)
    UTS("‚ú® Spawn...", "Spawning " .. STN)
    pcall(function() if R7 then R7:FireServer(uuid) end end)
    
    local hrp = GHRP()
    if hrp then LSP = hrp.Position end
    CTE = os.time() + TD[STN].Duration
    
    task.spawn(function()
        for i = 1, 3 do
            task.wait(0.2)
            pcall(function() if R1 then R1:FireServer(1) end end)
        end
    end)
    
    local sp = LSP or Vector3.new(0,0,0)
    W:Notify({Title = "Spawned!", Content = string.format("%s at X:%.1f Y:%.1f Z:%.1f", STN, sp.X, sp.Y, sp.Z), Duration = 3, Icon = "check"})
    return true
end

local function RATL()
    if ATT then task.cancel(ATT) end
    ATT = task.spawn(function()
        local hrp = GHRP()
        if hrp then
            local p = hrp.Position
            UTS("üöÄ Init...", string.format("X:%.1f Y:%.1f Z:%.1f", p.X, p.Y, p.Z))
        end
        while ATA do
            local tl = CTE - os.time()
            local hrp = GHRP()
            local cp = hrp and hrp.Position or Vector3.new(0,0,0)
            if tl > 0 then
                local m = math.floor((tl % 3600) / 60)
                local s = math.floor(tl % 60)
                if HPM() then
                    UTS(string.format("‚è≥ %s (Moved)", STN), string.format("Next: %02d:%02d\nüìç X:%.1f Y:%.1f Z:%.1f\n‚ö†Ô∏è Will spawn here!", m, s, cp.X, cp.Y, cp.Z))
                else
                    UTS(string.format("‚è≥ %s Active", STN), string.format("Next: %02d:%02d\nüìç X:%.1f Y:%.1f Z:%.1f", m, s, cp.X, cp.Y, cp.Z))
                end
            else
                UTS("üîç Check...", "Searching " .. STN)
                local ss = STCP()
                if not ss then task.wait(10) end
            end
            task.wait(1)
        end
    end)
end

-- UI
local ft = Win:Tab({Title = "Fishing", Icon = "fish", Locked = false})
local bs = ft:Section({Title = "Blatant Mode", TextSize = 20})

bs:Input({Title = "Interval", Value = tostring(LI), Icon = "fast-forward", Type = "Input", Placeholder = "1.58",
    Callback = function(i) local n = tonumber(i) if n and n >= 0.5 then LI = n end end})
bs:Input({Title = "Complete", Value = tostring(CD), Icon = "loader", Type = "Input", Placeholder = "2.75",
    Callback = function(i) local n = tonumber(i) if n and n >= 0.5 then CD = n end end})
bs:Input({Title = "Cancel", Value = tostring(CaD), Icon = "clock", Type = "Input", Placeholder = "0.3",
    Callback = function(i) local n = tonumber(i) if n and n >= 0.1 then CaD = n end end})

bs:Toggle({Title = "Instant Fishing", Value = false,
    Callback = function(st)
        BS = st
        _G.PH_BA = st
        SGV(st)
        if st then
            if R6 then
                pcall(function() R6:InvokeServer(true) end)
                task.wait(0.5)
                pcall(function() R6:InvokeServer(true) end)
                pcall(function() R6:InvokeServer(true) end)
            end
            BLT = task.spawn(function()
                while BS do RBI() task.wait(LI) end
            end)
            if BET then task.cancel(BET) end
            BET = task.spawn(function()
                while BS do
                    pcall(function() if R1 then R1:FireServer(1) end end)
                    task.wait(0.1)
                end
            end)
            W:Notify({Title = "ON", Duration = 3, Icon = "zap"})
        else
            if R6 then pcall(function() R6:InvokeServer(false) end) end
            if BLT then task.cancel(BLT) BLT = nil end
            if BET then task.cancel(BET) BET = nil end
            W:Notify({Title = "OFF", Duration = 2})
        end
    end})

local at = Win:Tab({Title = "Auto Fav", Icon = "star", IconColor = Color3.fromHex("#FFD700"), IconShape = true, Locked = false})
local fs = at:Section({Title = "Filters", TextSize = 20})

fs:Paragraph({Title = "‚ö†Ô∏è Status", Content = UL and "‚úÖ Ready!" or "‚è≥ Loading...", Icon = "info"})
fs:Button({Title = "Retry Load", Icon = "refresh-cw", Desc = "Click if failed",
    Callback = function()
        W:Notify({Title = "Retry...", Content = "Loading utils...", Duration = 2, Icon = "loader"})
        task.spawn(function()
            if LU() then
                W:Notify({Title = "OK!", Content = "Utils loaded!", Duration = 3, Icon = "check"})
            else
                W:Notify({Title = "Fail", Content = "Still failed", Duration = 5, Icon = "x"})
            end
        end)
    end})

at:Divider()

fs:Dropdown({Title = "Rarity", Values = {"COMMON", "UNCOMMON", "RARE", "EPIC", "LEGENDARY", "MYTHIC", "SECRET"},
    Multi = true, AllowNone = true, Value = false,
    Callback = function(v) SR = v or {} end})

local ain = GAIO()
fs:Dropdown({Title = "Item Name", Values = ain, Multi = true, AllowNone = true, Value = false,
    Callback = function(v) SN = v or {} end})

fs:Dropdown({Title = "Mutation", Values = {"Shiny", "VariantId"}, Multi = true, AllowNone = true, Value = false,
    Callback = function(v) SM = v or {} end})

at:Divider()

fs:Toggle({Title = "Auto Favorite", Desc = "Enable auto favorite", Value = false,
    Callback = function(st)
        AFS = st
        if st then
            if AUFS then
                AUFS = false
                if AUFT then task.cancel(AUFT) AUFT = nil end
            end
            if not GPDR() then
                W:Notify({Title = "Error", Content = "Replion failed", Duration = 3, Icon = "x"})
                return false
            end
            if not UL then
                W:Notify({Title = "Warn", Content = "Utils not loaded!", Duration = 5, Icon = "alert-triangle"})
                return false
            end
            W:Notify({Title = "Fav ON!", Duration = 3, Icon = "check"})
            RAFL()
        else
            W:Notify({Title = "Fav OFF!", Duration = 3, Icon = "x"})
            if AFT then task.cancel(AFT) AFT = nil end
        end
    end})

fs:Toggle({Title = "Auto Unfavorite", Desc = "Enable auto unfavorite", Value = false,
    Callback = function(st)
        AUFS = st
        if st then
            if AFS then
                AFS = false
                if AFT then task.cancel(AFT) AFT = nil end
            end
            if #SR == 0 and #SN == 0 and #SM == 0 then
                W:Notify({Title = "Warn!", Content = "All filters empty!", Duration = 5, Icon = "alert-triangle"})
                return false
            end
            if not GPDR() then
                W:Notify({Title = "Error", Content = "Replion failed", Duration = 3, Icon = "x"})
                return false
            end
            if not UL then
                W:Notify({Title = "Warn", Content = "Utils not loaded!", Duration = 5, Icon = "alert-triangle"})
                return false
            end
            W:Notify({Title = "Unfav ON!", Duration = 3, Icon = "check"})
            RAUL()
        else
            W:Notify({Title = "Unfav OFF!", Duration = 3, Icon = "x"})
            if AUFT then task.cancel(AUFT) AUFT = nil end
        end
    end})

local pt = Win:Tab({Title = "Premium", Icon = "star", IconColor = Color3.fromHex("#42f5b9"), IconShape = true, Locked = false})
local ts = pt:Section({Title = "Auto Totem", TextSize = 20})
pt:Divider()

TSP = ts:Paragraph({Title = "üí§ Idle", Content = "Aktifkan toggle.\n\n‚ú® Timer persistent!\nüìç Spawn di posisi baru.", Icon = "clock"})

ts:Dropdown({Title = "Totem Type", Values = TN, Value = STN, Multi = false,
    Callback = function(n)
        STN = n
        CTE = 0
        LSP = nil
        UTS("üîÑ Changed", "Switched to " .. n .. "\nReset.")
    end})

ts:Toggle({Title = "Enable Auto Totem", Desc = "Smart timer + detect move", Value = false,
    Callback = function(st)
        ATA = st
        if st then
            RATL()
            W:Notify({Title = "Totem ON", Content = "Timer persistent!", Duration = 3, Icon = "play"})
        else
            if ATT then task.cancel(ATT) ATT = nil end
            UTS("‚èπÔ∏è Stop", "Disabled.\nReset.")
            CTE = 0
            LSP = nil
            W:Notify({Title = "Totem OFF", Duration = 2, Icon = "square"})
        end
    end})

ts:Button({Title = "Manual Spawn", Icon = "zap", Desc = "Spawn once",
    Callback = function()
        local s = STCP()
        if s then W:Notify({Title = "OK", Content = "Reset to 60min", Duration = 3, Icon = "check"}) end
    end})

ts:Button({Title = "Reset Timer", Icon = "refresh-cw", Desc = "Reset countdown",
    Callback = function()
        CTE = 0
        LSP = nil
        UTS("üîÑ Reset", "Ready!")
        W:Notify({Title = "Reset", Content = "0", Duration = 2, Icon = "rotate-ccw"})
    end})

Win:Tag({Title = "Opt V1.6", Color = Color3.fromHex("#F5C527"), Radius = 9})
W:Notify({Title = "Plenger Hub V1.6", Content = "Optimized & Fixed!", Duration = 5, Icon = "info"})

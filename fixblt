local WindUI

do
    local ok, result = pcall(function()
        return require("./src/Init")
    end)
    
    if ok then
        WindUI = result
    else 
        WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
    end
end

local svc = {
    Players = game:GetService("Players"),
    RS = game:GetService("ReplicatedStorage"),
    RunService = game:GetService("RunService"),
}

local player = svc.Players.LocalPlayer

local function waitForCharacter()
    return player.Character or player.CharacterAdded:Wait()
end

local character = waitForCharacter()
local hrp = character:WaitForChild("HumanoidRootPart", 10)

local mods = {
    Net = nil,
}

local api = {
    Events = {},
    Functions = {},
}

local function InitializeAPI()
    local success, err = pcall(function()
        mods.Net = svc.RS:WaitForChild("Packages", 5):WaitForChild("_Index", 5):WaitForChild("sleitnick_net@0.2.0", 5):WaitForChild("net", 5)
        
        api.Events.EquipTool = mods.Net:WaitForChild("RE/EquipToolFromHotbar", 5)
        api.Functions.ChargeRod = mods.Net:WaitForChild("RF/ChargeFishingRod", 5)
        api.Functions.StartMini = mods.Net:WaitForChild("RF/RequestFishingMinigameStarted", 5)
        api.Functions.CatchFish = mods.Net:WaitForChild("RF/CatchFishCompleted", 5)
        api.Functions.CancelFish = mods.Net:WaitForChild("RF/CancelFishingInputs", 5)
    end)
    
    return success
end

if not InitializeAPI() then
    warn("Failed to initialize API, retrying...")
    task.wait(2)
    if not InitializeAPI() then
        error("Could not find game API")
        return
    end
end

local Window = WindUI:CreateWindow({
    Title = "LS Hub - Fish It",
    Author = "developed by Louissxe",
    Folder = "LSHub-FishIt",
    Icon = "rbxassetid://129609617845057",
    Transparent = true,
    IconSize = 24,
    NewElements = true,
    Size = UDim2.fromOffset(500, 400),
    ToggleKey = Enum.KeyCode.G,
    User = {
        Enabled = true,
        Anonymous = true,
    },
    HideSearchBar = true,
    OpenButton = {
        Title = "Open LS Hub",
        CornerRadius = UDim.new(0.3,0),
        StrokeThickness = 3,
        Enabled = true,
        Draggable = true,
        OnlyMobile = false,
        Color = ColorSequence.new(
            Color3.fromRGB(107, 49, 255), 
            Color3.fromRGB(215, 48, 221)
        )
    },
    Topbar = {
        Height = 44,
        ButtonsType = "Default",
    },
})

local Fish10 = Window:Tab({
    Title = "Fishing Cycle",
    Icon = "bird",
    Locked = false,
})

local Protected = false
local FishingSession = 0

_G.DelayComplete = 0
_G.DelayCycle = 0.1

local function IsSessionAlive(session)
    return FishingSession == session and Protected
end

local function SpamFishing(session)
    local equipped = pcall(function()
        api.Events.EquipTool:FireServer(1)
    end)
    
    if equipped then
        task.wait(0.5)
    end
    
    while IsSessionAlive(session) do
        local success, err = pcall(function()
            local now = workspace:GetServerTimeNow()
            
            task.spawn(function()
                pcall(function()
                    api.Functions.ChargeRod:InvokeServer(now)
                end)
            end)
            
            if _G.DelayComplete > 0 then task.wait(_G.DelayComplete) end
            
            task.spawn(function()
                pcall(function()
                    api.Functions.StartMini:InvokeServer(-1, 1, now)
                end)
            end)
            
            if _G.DelayComplete > 0 then task.wait(_G.DelayComplete) end
            
            task.spawn(function()
                pcall(function()
                    api.Functions.CatchFish:InvokeServer()
                end)
            end)
            
            if _G.DelayComplete > 0 then task.wait(_G.DelayComplete) end
            
            task.spawn(function()
                pcall(function()
                    api.Functions.CancelFish:InvokeServer()
                end)
            end)
        end)
        
        if not success then
            warn("Fishing error:", err)
        end
        
        if _G.DelayCycle > 0 then 
            task.wait(_G.DelayCycle)
        else
            task.wait()
        end
    end
end

Fish10:Input({
    Title = "Delay Complete",
    Description = "Delay per action (0 = instant)",
    Value = tostring(_G.DelayComplete),
    Callback = function(v)
        local n = tonumber(v)
        if n and n >= 0 then
            _G.DelayComplete = n
        end
    end,
})

Fish10:Input({
    Title = "Delay Cycle", 
    Description = "Delay antar cycle fishing",
    Value = tostring(_G.DelayCycle),
    Callback = function(v)
        local n = tonumber(v)
        if n and n >= 0 then
            _G.DelayCycle = n
        end
    end,
})

Fish10:Toggle({
    Title = "Start Auto Fishing",
    Default = false,
    Callback = function(s)
        if s then
            Protected = true
            FishingSession = FishingSession + 1
            local currentSession = FishingSession
            
            task.spawn(function()
                local success, err = pcall(function()
                    SpamFishing(currentSession)
                end)
                
                if not success then
                    warn("Fishing loop error:", err)
                    Protected = false
                end
            end)
        else
            Protected = false
        end
    end,
})

player.CharacterAdded:Connect(function(char)
    character = char
    hrp = char:WaitForChild("HumanoidRootPart", 10)
end)
